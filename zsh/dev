#!/bin/zsh

# dev command
export DEV_PROJECTS_FILE=~/.local/share/dev-projects/dev

if [[ ! -d ~/.local/share/dev-projects ]]; then
	mkdir -p ~/.local/share/dev-projects
fi

function dev_add() {
	local KEY=$1
	local DIR=$(pwd)

	if [[ ! -f $DEV_PROJECTS_FILE ]]; then
		printf "%s\t%s\n" "$KEY" "$DIR" > ~/.dev
	else
		cat <(awk -F "\t" -v "key=$KEY" '{ if ($1 != key) { print $0 } }' ~/.dev) <(printf "%s\t%s\n" "$KEY" "$DIR") | sort > ~/.dev_tmp
		mv ~/.dev_tmp $DEV_PROJECTS_FILE
	fi
}

function dev_delete() {
	local KEY=$1

	if [[ ! -f $DEV_PROJECTS_FILE ]]; then
		return 1
	fi

	awk -F "\t" -v "key=$KEY" '{ if ($1 != key) { print $0 } }' $DEV_PROJECTS_FILE > ~/.dev_tmp
	mv ~/.dev_tmp $DEV_PROJECTS_FILE
}

function dev_cd() {
	local KEY DIR

	KEY="$1"
	if [[ -z "$KEY" ]]; then
		local SELECTED=$(cat $DEV_PROJECTS_FILE | column -t | fzf)
		if [[ -z $SELECTED ]]; then
			return 1
		fi

		local KEY_DIR=($(echo $SELECTED | awk '{ print $1, $2 }'))
		KEY=$KEY_DIR[1]
		DIR=$KEY_DIR[2]
	else
		DIR=$(awk -F "\t" -v "key=$KEY" '{ if ($1 == key) { print $2; exit } }' $DEV_PROJECTS_FILE)
	fi

	if [ -z "$DIR" ] || [ ! -d "$DIR" ]; then
		return 1
	fi

	cd "$DIR" || return 1

	title $KEY

	pwd
}


function dev_list() {
	column -t < $DEV_PROJECTS_FILE
}

function dev() {
	while getopts d:a:sl OPT
	do
		case $OPT in
			l)
				dev_list
				return $!
				;;
			a)
				dev_add "$OPTARG"
				return $!
				;;
			d)
				dev_delete "$OPTARG"
				return $!
				;;
			*)
				return 1
		esac
	done
	dev_cd $1
}

function _dev_projects() {
	local -a CD_LIST
	CD_LIST=( $(cat $DEV_PROJECTS_FILE | cut -f 1) )
	_describe "Projects" CD_LIST
}

function _dev_pwd() {
	_values "keyword candidates" $(basename ${PWD})
}

function _dev() {
	_arguments \
		'(- *)'-l'[list all projects]' \
		'(- *)'-a'[add project]:keyword:_dev_pwd' \
		'(- *)'-d'[delete project]:project:_dev_projects' \
		'(- *)*:project:_dev_projects'
}

compdef _dev dev

